# Critical Fixes - Project Persistence and File Upload Issues

## Summary of Issues Fixed

You reported three critical issues that prevented the application from working:

1. **Projects not saving to database** - Created projects disappeared on refresh
2. **Files not uploading** - "Row-level security policy" errors
3. **User ID mismatch** - Database queries returning "No user ID found" errors

All three issues stemmed from a **fundamental architectural problem**: the application was using the wrong user ID for database operations.

## Root Cause Analysis

### The Problem
The application had two different user ID systems:
- **Application User ID**: Generated by the `users` table during onboarding (what `localUserData.id` contains)
- **Supabase Auth UID**: The actual UUID generated by Supabase's authentication system

**The Critical Bug**: All database functions (`saveProject`, `loadProjects`, `uploadFile`) were using the application user ID, but Supabase's Row-Level Security (RLS) policies check `auth.uid()` which is the Supabase auth UID.

This mismatch meant:
- Projects were saved with `user_id = {appUserId}` but RLS policies checked `auth.uid() = {authUid}`
- Since they didn't match, the RLS policies rejected read/write operations
- Files couldn't upload because the storage bucket RLS policies couldn't verify the user

## Changes Made

### 1. Fixed Database Functions (lib/database.ts)

**saveProject()**
```typescript
// BEFORE: Used passed userId (application user ID)
const projectData = {
  user_id: userId,
  ...
};

// AFTER: Gets the real Supabase auth UID
const authUser = await supabase.auth.getUser();
const authUid = authUser.data.user?.id;
if (!authUid) throw new Error('No authenticated user found. Please log in again.');

const projectData = {
  user_id: authUid, // Use Supabase auth UID for RLS
  ...
};
```

**loadProjects()**
- Now retrieves `auth.uid()` instead of using passed userId
- Queries projects table with correct user_id that matches auth.uid()

**deleteProject()**
- Now retrieves `auth.uid()` instead of using passed userId
- Ensures deletion only works for authenticated user's projects

### 2. Fixed File Upload Function (lib/supabaseStorage.ts)

**uploadFile()**
```typescript
// BEFORE: File path was {projectId}/{taskId}/{timestamp}-{filename}
const filePath = `${projectId || 'general'}/${taskId || 'project'}/${timestamp}-${sanitizedName}`;

// AFTER: File path includes auth UID as first folder
// This allows RLS policies to verify ownership by checking first folder = auth.uid()
const filePath = `${authUid}/${projectId || 'general'}/${taskId || 'project'}/${timestamp}-${sanitizedName}`;
```

### 3. Created Database Migrations

**Migration 003** (`supabase/migrations/003_enable_rls_on_projects.sql`)
- Enables RLS on `projects` table
- Creates policies: users can only see/modify/delete their own projects
- Enables RLS on `tasks` table with permissive policies (can be restricted later)

**Migration 004** (`supabase/migrations/004_create_storage_bucket_policies.sql`)
- Creates RLS policies for storage bucket `pimbot-attachments`
- Policies verify that file path's first folder matches `auth.uid()`
- Allows users to upload, read, delete, and update their own files

## What You Need to Do

### CRITICAL: Run These Migrations in Supabase

The code changes are complete, but you must run the SQL migrations in Supabase for the fixes to work:

1. **Open Supabase Dashboard** → SQL Editor
2. **Create new query** and run Migration 003 (enable RLS)
3. **Create storage bucket**: Storage → New Bucket → Name: `pimbot-attachments` → Privacy: Private
4. **Create new query** and run Migration 004 (storage RLS policies)

**See `MIGRATION_INSTRUCTIONS.md` for detailed step-by-step guide**

### Test the Fixes

After running migrations:

1. **Rebuild the app**: `npm run dev` (already running)
2. **Log in** to the application
3. **Create a new project** - You should see it save successfully
4. **Refresh the page** - The project should still be there
5. **Try uploading a file** - Should work without RLS errors
6. **Refresh again** - File should persist

## Technical Details

### How RLS Works Now

**Projects Table:**
- Column: `user_id UUID`
- Policy: `user_id = auth.uid()`
- Result: Users can only access projects where their auth UID matches

**Storage Bucket:**
- File path: `{authUid}/{projectId}/{taskId}/{filename}`
- Policy: Extracts first folder with `storage.foldername(name)[1]` and checks if it equals `auth.uid()`
- Result: Users can only access files in their own `{authUid}/` folder

### Why This Works

1. **Supabase Auth UID** is globally unique and controlled by Supabase
2. **RLS checks `auth.uid()`** - the actual authenticated user
3. **File path includes `auth.uid()`** - allows RLS to verify ownership without additional queries
4. **Database operations use `auth.uid()`** - all operations are filtered by RLS to only user's own data

## Common Issues & Solutions

| Issue | Cause | Solution |
|-------|-------|----------|
| "No authenticated user found" | User not logged into Supabase | Complete onboarding which creates Supabase auth account |
| "Row-level security policy" error | Storage bucket RLS policies not set up | Run Migration 004 in Supabase |
| Projects disappear on refresh | Old projects saved with wrong user_id | Create new projects after migrations |
| "Column attachments not found" | Projects table missing attachments column | Should exist from Migration 000, check schema |
| Files not uploading after migration | Storage bucket not created | Manually create `pimbot-attachments` bucket in Supabase Storage |

## Files Changed

### Modified
- `lib/database.ts` - Updated saveProject, loadProjects, deleteProject
- `lib/supabaseStorage.ts` - Updated uploadFile with auth.uid() and new file path structure

### Created
- `supabase/migrations/003_enable_rls_on_projects.sql` - Enable RLS on projects/tasks
- `supabase/migrations/004_create_storage_bucket_policies.sql` - Storage bucket policies
- `MIGRATION_INSTRUCTIONS.md` - Step-by-step Supabase setup guide
- `FIX_SUMMARY.md` - This file

## Commit

All changes committed as: `66227dd - Fix critical database and file upload issues - use Supabase auth UID for RLS`

## Next Steps After Migrations

1. Verify RLS is enabled
2. Test project creation and persistence
3. Test file uploads
4. Implement team member features (separate task)
5. Implement task assignment (separate task)

## Questions?

If you encounter issues:
1. Check the browser console for error messages
2. Check Supabase dashboard → Logs for database/storage errors
3. Verify that all migrations ran successfully
4. Ensure storage bucket was created with correct name and privacy setting
